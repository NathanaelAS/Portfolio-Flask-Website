{% extends "base.html" %}

{% block title %}Blog Page{% endblock %}

{% block styles %}
	<style>
		*{
			box-sizing: border-box;
		}
		html, body {
			height: 100%;
			margin: 0;
			padding: 0;
		}
		.posts-container {
			display: flex;
			flex-direction: column;
			gap: 20px;
			max-height: 60vh;
			overflow: auto;
			background-color: rgb(184, 184, 184);
			padding: 20px;
			box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15)
		}
		.post-card {
			box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
			border: 1px solid black;
			margin-bottom: 15px;
		}
		.blog-page-header {
			background-color: rgb(95, 95, 95);
		}
		.user-greeting{
			color: white;
		}
		.create-post{
			padding: 10px;
			background-color: rgb(243, 246, 247);
			border-radius: 10px;
		}
		.posts-list{
			flex-grow: 1;
			overflow-y: auto;
			padding: 10px;
			min-height: 0;
		}
		.admin-author{
			color:red;
			font-weight: bold;
		}
	</style>
{% endblock %}

{% block content %}
    <div class='py-3 bg-light text-center'>
		<h1 class='mt-3 mb-3'>Blog Home Page</h1>
	</div>

	<div id="blog-page-header" class="text-end py-2 px-4 mb-3 blog-page-header">
		{% if current_user.is_authenticated %}
			<span class="user-greeting me-2">Welcome, {{ current_user.username }}!</span>
			<a href="#" id="logout-button" class="btn btn-danger me-2">Logout</a>
			<a href="{{ url_for('projects.blog_page') }}" class="btn btn-primary me-2">Home</a>
			<a href="{{ url_for('projects.blog_account_page') }}" class="btn btn-primary">Account</a>
		{% else %}
			<a href="{{ url_for('projects.blog_page') }}" class="btn btn-primary me-2">Home</a>
			<a href="{{ url_for('projects.blog_login_page') }}" class="btn btn-primary me-2">Login</a>
			<a href="{{ url_for('projects.blog_register_page') }}" class="btn btn-primary">Register</a>
		{% endif %}
	</div>

	<div class="container">
		<div id="posts-container" class="posts-container rounded-4">

			<div id="posts-list"></div>

			{% if current_user.is_authenticated %}
				<div id="create-post" class="create-post">
					<form id="post-form" method="POST" action="{{ url_for('projects.blog_page') }}" class="d-flex align-items-center">
						<div class="d-flex flex-grow-1 justify-content-center align-items-center">
							<label for="post-title" class="me-2 fw-bold form-label">Title:</label>
							<input type="text" name="post-title" id="post-title" class="form-control me-5">
							<label for="post-content" class="me-2 fw-bold form-label">Content:</label>
							<input type="text" name="post-content" id="post-content" class="form-control me-5">
						</div>
						<button type="submit" class="btn btn-success ms-auto me-2">Post</button>
					</form>
				</div>
			{% endif %}
			
			
		</div>


	</div>

{% endblock %}

{% block scripts %}
	<script>
		function validateInput(inputElement) {
            if(inputElement.value === ''){
                inputElement.classList.remove('is-valid');
                inputElement.classList.add('is-invalid');
                return false;
            }else{
                inputElement.classList.remove('is-invalid');
                inputElement.classList.add('is-valid');
                return true;
            }
        }

		
		const logoutButton = document.getElementById('logout-button');

		if(logoutButton){
			logoutButton.addEventListener('click', (event) => {
				event.preventDefault();

				fetch('/projects/blog/logout', {
					method: 'POST',
				})
				.then(response => {
					if(response.redirected){
						window.location.href = response.url;
					} else{
						return response.json();
					}
				})
				.catch(error => {
					console.error('Error during logout:', error);
					alert('Logout failed due to an error.')
				})
			})
		}

		const postForm = document.getElementById('post-form')
		const createPostDiv = document.getElementById('create-post')

		function fetchAndRenderPosts(){
			const postListDiv = document.getElementById('posts-list')
			postListDiv.innerHTML = '';

			return fetch('/projects/blog/get_posts', {
				method: 'GET',
			})
			.then(response => {
				if(!response.ok){
					throw new Error('Network response was not ok');
				}
				return response.json();
			})
			.then(posts => {

				const postsElements = []

				posts.forEach(post => {
					
					const postCardDiv = document.createElement('div');
					postCardDiv.classList.add('card', 'post-card');
					postCardDiv.id = `post-${post.id}`

					const postTitle = document.createElement('div');
					postTitle.innerHTML = `<strong>${post.title}</strong>`;
					postTitle.classList.add('card-header');

					const postContent = document.createElement('div');
					postContent.innerHTML = `
						<small>User: <i class="${post.author === 'Admin' ? 'admin-author' : ''}">${post.author}</i></small><br>
						<small>${post.created_at}</small>
						<hr>
						<p>${post.content}</p>
					`;

					postContent.classList.add('card-body');

					postCardDiv.appendChild(postTitle);
					postCardDiv.appendChild(postContent);

					postListDiv.appendChild(postCardDiv);
				});
				const postContainerDiv = document.getElementById('posts-container')

				if(!window.location.hash){
					window.requestAnimationFrame(() => {
						postContainerDiv.scrollTop = postContainerDiv.scrollHeight;
					});
				}
				
				

			})
			.catch(error => {
				console.error('There was a problem with the fetch operation', error);
				postListDiv.innerHTML = `<p>Failed to load posts. Please try again later.</p>`;
			})
		}

		document.addEventListener('DOMContentLoaded', () => {
			fetchAndRenderPosts().then(() => {
				const hash = window.location.hash;

				if(hash){
					const targetID = hash.substring(1);
					const targetPost = document.getElementById(targetID);

					if(targetPost){
						targetPost.scrollIntoView({
							behavior: 'smooth',
							block: 'start'
						});
					}
				}
			});

		})

		if(postForm){
			postForm.addEventListener('submit', (event) => {
				event.preventDefault();

				const postTitle = document.getElementById('post-title');
				const postContent = document.getElementById('post-content');

				const isTitleValid = validateInput(postTitle);
				const isContentValid = validateInput(postContent);

				if(isTitleValid && isContentValid){
					fetch('/projects/blog/create_post', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							postTitle: postTitle.value,
							postContent: postContent.value
						})
					})
					.then(response => {
						if(!response.ok){
							throw new Error('Network response was not ok');
						}
						return response.json();
					})
					.then(data => {
						console.log(data.message);

						fetchAndRenderPosts();
					})
					.catch(error => {
						console.error('There was a problem with creating your post', error);
					})
				}
				
			})
		}
		
	</script>
{% endblock %}