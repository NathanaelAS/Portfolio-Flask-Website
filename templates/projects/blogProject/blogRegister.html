{% extends "base.html" %}

{% block title %}Blog Register Page{% endblock %}

{% block styles %}
    <style>
        .blog-page-header {
			background-color: rgb(95, 95, 95);
		}
    </style>
{% endblock %}

{% block content %}
    <div class='py-3 bg-light text-center'>
		<h1 class='mt-3 mb-3'>Blog Register Page</h1>
	</div>

    <div id="blog-page-header" class="text-end py-2 px-4 mb-3 blog-page-header">
        <a href="{{ url_for('projects.blog_page') }}" class="btn btn-primary me-2">Home</a>
        <a href="{{ url_for('projects.blog_login_page') }}" class="btn btn-primary me-2">Login</a>
        <a href="{{ url_for('projects.blog_register_page') }}" class="btn btn-primary">Register</a>
	</div>

    <div class="container my-5">
        <div class="card p-4 mx-auto shadow" style="max-width: 400px;">
            <h3 class="text-center mb-4">Register Account</h3>
            <form id="registration-form" method="POST" action="{{ url_for('projects.blog_register_page') }}">
                <div class="mb-3">
                    <label for="username" class="form-label">Username:</label>
                    <input type="text" class="form-control" id="username">
                    <div id="username-check" class="form-text"></div>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Password:</label>
                    <input type="password" class="form-control" id="password">
                </div>
                <div class="mb-3">
                    <label for="confirm-password" class="form-label">Confirm Password:</label>
                    <input type="password" class="form-control" id="confirm-password">
                    <div id="password-error" class="form-text text-danger"></div>
                </div>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success">Register</button>
                    <p class="mt-2 text-center">If you already have an account, please <a href="{{ url_for('projects.blog_login_page') }}">Login here</a></p>
                </div>
                
            </form>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        const registrationForm = document.getElementById('registration-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const errorMsgDiv = document.getElementById('password-error');
        const usernameCheckDiv = document.getElementById('username-check');

        let isUsernameAvailable = false;

        function debounce(func, delay){
            let timeoutID;

            return function(...args){
                clearTimeout(timeoutID);

                timeoutID = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        function checkUsernameAvailability(){
            const username = usernameInput.value;

            if (username.length > 0){
                fetch(`/projects/blog/register/check_username?username=${username}`)
                .then(response => response.json())
                .then(data => {
                    isUsernameAvailable = data.is_available;

                    if (isUsernameAvailable){
                        usernameInput.classList.remove('is-invalid');
                        usernameInput.classList.add('is-valid');
                        usernameCheckDiv.textContent = 'Username is available!';
                        usernameCheckDiv.classList.remove('text-danger');
                        usernameCheckDiv.classList.add('text-success');
                    } else{
                        usernameInput.classList.remove('is-valid');
                        usernameInput.classList.add('is-invalid');
                        usernameCheckDiv.textContent = 'Username is already taken.';
                        usernameCheckDiv.classList.remove('text-success');
                        usernameCheckDiv.classList.add('text-danger');
                    }
                });
            } else{
                usernameInput.classList.remove('is-valid', 'is-invalid');
                usernameCheckDiv.textContent = '';
            }
        }

        usernameInput.addEventListener('input', debounce(checkUsernameAvailability, 500));

        function validateInput(inputElement) {
            if(inputElement.value === ''){
                inputElement.classList.remove('is-valid');
                inputElement.classList.add('is-invalid');
                return false;
            }else{
                inputElement.classList.remove('is-invalid');
                inputElement.classList.add('is-valid');
                return true;
            }
        }

        registrationForm.addEventListener('submit', (event) => {
            event.preventDefault();

            const isUsernameValid = validateInput(usernameInput)
            const isPasswordValid = validateInput(passwordInput)
            const isConfirmPasswordValid = validateInput(confirmPasswordInput)
            var passwordsMatch = false;
            
            if(passwordInput.value !== confirmPasswordInput.value){
                errorMsgDiv.textContent = 'Passwords do not match!';
                passwordsMatch = false;
            }
            else{
                errorMsgDiv.textContent = '';
                passwordsMatch = true;
            }

            if(isUsernameValid && isPasswordValid && isConfirmPasswordValid && passwordsMatch && isUsernameAvailable){
                fetch('/projects/blog/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: usernameInput.value,
                        password: passwordInput.value
                    })
                })
                .then(response => {
                    if(response.redirected){
                        window.location.href = response.url;

                        return new Promise(() => {});
                    }

                    if(!response.ok){
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Error', error);
                })
            }

        });
    </script>
{% endblock %}